<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="安卓开发,即时通讯,个人主观," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="原创声明：本文属于原创总结，部分文字摘自网络，已标署名，转载请附上转载链接。http://notes.zhaoshuai123.com

技术发展到现在已经不流行重复造轮子了，因为轮子的结构越来越复杂，功能性和非功能性的指标要求越来越高；而我们的用户却不会再等我们了。当我们还在画轮子的图纸的时候，竞争对手可能已经把车子都造好，甩出我们好几条长安街。需求IM功能齐全，技术支持到位的话，直接调用即可。">
<meta property="og:type" content="article">
<meta property="og:title" content="即时通讯类项目开发总结">
<meta property="og:url" content="http://yoursite.com/2016/08/30/即时通讯类项目开发总结/index.html">
<meta property="og:site_name" content="程序员Patrick_Zhao">
<meta property="og:description" content="原创声明：本文属于原创总结，部分文字摘自网络，已标署名，转载请附上转载链接。http://notes.zhaoshuai123.com

技术发展到现在已经不流行重复造轮子了，因为轮子的结构越来越复杂，功能性和非功能性的指标要求越来越高；而我们的用户却不会再等我们了。当我们还在画轮子的图纸的时候，竞争对手可能已经把车子都造好，甩出我们好几条长安街。需求IM功能齐全，技术支持到位的话，直接调用即可。">
<meta property="og:image" content="http://ocalhyke7.bkt.clouddn.com/141612jaaglsb8ghh22sbs.png">
<meta property="og:updated_time" content="2016-08-31T02:53:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="即时通讯类项目开发总结">
<meta name="twitter:description" content="原创声明：本文属于原创总结，部分文字摘自网络，已标署名，转载请附上转载链接。http://notes.zhaoshuai123.com

技术发展到现在已经不流行重复造轮子了，因为轮子的结构越来越复杂，功能性和非功能性的指标要求越来越高；而我们的用户却不会再等我们了。当我们还在画轮子的图纸的时候，竞争对手可能已经把车子都造好，甩出我们好几条长安街。需求IM功能齐全，技术支持到位的话，直接调用即可。">
<meta name="twitter:image" content="http://ocalhyke7.bkt.clouddn.com/141612jaaglsb8ghh22sbs.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6219980248432248000,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/08/30/即时通讯类项目开发总结/"/>

  <title> 即时通讯类项目开发总结 | 程序员Patrick_Zhao </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7eef02482ad788ec5c9658901ec8e5b3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">程序员Patrick_Zhao</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                即时通讯类项目开发总结
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-30T14:47:13+08:00" content="2016-08-30">
              2016-08-30
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/30/即时通讯类项目开发总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/30/即时通讯类项目开发总结/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>原创声明：本文属于原创总结，部分文字摘自网络，已标署名，转载请附上转载链接。<br><a href="http://notes.zhaoshuai123.com" target="_blank" rel="external">http://notes.zhaoshuai123.com</a></p>
<blockquote>
<p>技术发展到现在已经不流行重复造轮子了，因为轮子的结构越来越复杂，功能性和非功能性的指标要求越来越高；而我们的用户却不会再等我们了。当我们还在画轮子的图纸的时候，竞争对手可能已经把车子都造好，甩出我们好几条长安街。需求IM功能齐全，技术支持到位的话，直接调用即可。<br>本文会从零开始会大家去分析介绍一个即时通讯类项目需要了解的知识点，内容多数摘自网络，原文链接无从查找，请相关作者看到之后联系我，我将标注署名和链接.</p>
</blockquote>
<h1 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h1><h2 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a>OSI七层模型</h2><pre><code>OSI（Open System Interconnect），即开放式系统互联。 一般都叫OSI参考模型，是ISO（国际标准化组织）组  
织在1985年研究的网络互联模型。该体系结构标准定义了网络互连的七层框架（物理层、数据链路层、网络层、传输
层、会话层、表示层和应用层）.
</code></pre><table>
<thead>
<tr>
<th>OSI层</th>
<th>功能</th>
<th>TCP/IP协议簇</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>文件传输，电子邮件，文件服务，虚拟终端</td>
<td>TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet</td>
</tr>
<tr>
<td>表示层</td>
<td>数据格式化，代码转换，数据加密</td>
<td>没有协议</td>
</tr>
<tr>
<td>会话层</td>
<td>解除或建立与别的接点的联系</td>
<td>没有协议</td>
</tr>
<tr>
<td>传输层</td>
<td>提供端对端的接口</td>
<td>TCP，UDP</td>
</tr>
<tr>
<td>网络层</td>
<td>为数据包选择路由</td>
<td>IP，ICMP，RIP，OSPF，BGP，IGMP</td>
</tr>
<tr>
<td>数据链路层</td>
<td>传输有地址的帧以及错误检测功能</td>
<td>SLIP，CSLIP，PPP，ARP，RARP，MTU</td>
</tr>
<tr>
<td>物理层</td>
<td>以二进制数据形式在物理媒体上传输数据</td>
<td>ISO2110，IEEE802，IEEE802.2</td>
</tr>
</tbody>
</table>
<p>OSI参考模型详细说明<a href="http://baike.baidu.com/link?url=YvGt3TcovXDqcyf6lUn16EshyfGuaKoopVLr-b2JCUYvOs5rBQAAKz8f0wDwjWDK" title="百度百科OSI参考模型" target="_blank" rel="external">http://baike.baidu.com/link?url=YvGt3TcovXDqcyf6lUn16EshyfGuaKoopVLr-b2JCUYvOs5rBQAAKz8f0wDwjWDK</a></p>
<a id="more"></a>
<h2 id="TCP-IP-5层模型及对应的协议"><a href="#TCP-IP-5层模型及对应的协议" class="headerlink" title="TCP/IP 5层模型及对应的协议"></a>TCP/IP 5层模型及对应的协议</h2><table>
<thead>
<tr>
<th>TCP/IP的层</th>
<th>对应的TCP/IP协议</th>
<th>应用在各层的硬件设备</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层(Application)</td>
<td>Telnet: 远程登录  ，FTP（File Transfer Protocol）：文件传输协议 ，HTTP（Hyper Text Transfer Protocol）：超文本传输协议， SMTP（Simple Mail Transter Protocol）：简单邮件传输协议， POP3（Post Office Ptotocol）：邮局协议 ，SNMP（Simple Network Mangement Protocol）：简单网络管理协议，DNS（Domain Name System）：域名系统</td>
<td>应用程序网关（application gateway）（在应用层连接两部分应用程序）     </td>
</tr>
<tr>
<td>传输层（Transport）</td>
<td>TCP（Transmission Control Potocol)：传输控制协议 ，UDP（User Data Potocol）：用户数据协议</td>
<td>传输网关（transport gateway）（在传输层连接两个网络）</td>
</tr>
<tr>
<td>网络层（Internet）</td>
<td>IP（Internet Protocol）：网络协议ARP（Address Resolution Protocol）：地址解析协议，RARP（Reverse Address Resolution Protocol) ：逆地址解析协议，ICMP（Internet Control Message Protocol）：因特网控制消息协议，IGMP（Internet Group Manage Protocol）：因特网组管理协议，BOOTP （Bootstrap）：可选安全启动协议</td>
<td>多协议路由器（multiprotocol router）（在异构网络间转发分组）</td>
</tr>
<tr>
<td>数据链路层（Data Link）</td>
<td>HDLC（High Data Link Control）：高级数据链路控制，SLIP（Serial Line IP）：串行线路IP，PPP（Point-to-Point Protocol）：点到点协议，802.2等</td>
<td>网桥（bridge）交换机（switcher）（在LAN之间存储-转发数据链路针）</td>
</tr>
<tr>
<td>物理层（Physical）</td>
<td>无</td>
<td>中继器（repeater） 集线器（hub）（放大或再生弱的信号，在两个电缆段之间复制每一个比特）</td>
</tr>
</tbody>
</table>
<h2 id="TCP-UDP-Http-Socket的区别"><a href="#TCP-UDP-Http-Socket的区别" class="headerlink" title="TCP,UDP,Http,Socket的区别"></a>TCP,UDP,Http,Socket的区别</h2><ul>
<li>通过初步的了解，我们知道IP协议对应于网络层，TCP协议和UDP协议对应于传输层，而HTTP协议对应于应用层，四者从本质上来说没有可比性，socket则是对TCP/IP协议的封装和应用(程序员层面上)。也可以说，TPC/IP协议是传输层协议，主要解决数据如何在网络中传输，而HTTP是应用层协议，主要解决如何包装数据。</li>
<li>socket是对TCP/IP协议的封装，Socket本身并不是协议，而是一个调用接口（API），通过Socket，我们才能使用TCP/IP协议。实际上，Socket跟TCP/IP协议没有必然的联系。Socket编程接口在设计的时候，就希望也能适应其他的网络协议。所以说，Socket的出现只是使得程序员更方便地使用TCP/IP协议栈而已，是对TCP/IP协议的抽象，从而形成了我们知道的一些最基本的函数接口，比如create、 listen、connect、accept、send、read和write等等实际上，传输层的TCP是基于网络层的IP协议的，而应用层的HTTP协议又是基于传输层的TCP协议的，而Socket本身不算是协议，就像上面所说，它只是提供了一个针对TCP或者UDP编程的接口</li>
</ul>
<blockquote>
<p>总结为下表</p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>解释  </th>
</tr>
</thead>
<tbody>
<tr>
<td>IP</td>
<td>网络层协议  </td>
</tr>
<tr>
<td>TCP和UDP</td>
<td>传输层协议</td>
</tr>
<tr>
<td>HTTP</td>
<td>应用层协议</td>
</tr>
<tr>
<td>SOCKET</td>
<td>TCP/IP网络的API</td>
</tr>
<tr>
<td>TCP/IP</td>
<td>代表传输控制协议/网际协议，指的是一系列协议  </td>
</tr>
</tbody>
</table>
<ul>
<li>TCP和UDP使用IP协议从一个网络传送数据包到另一个网络。把IP想像成一种高速公路，它允许其它协议在上面行驶并找到到其它电脑的出口。TCP和UDP是高速公路上的“卡车”，它们携带的货物就是像HTTP，文件传输协议FTP这样的协议等。</li>
<li>TCP和UDP是FTP，HTTP和SMTP之类使用的传输层协议。虽然TCP和UDP都是用来传输其他协议的，它们却有一个显著的不同：TCP提供有保证的数据传输，而UDP不提供。这意味着TCP有一个特殊的机制来确保数据安全的不出错的从一个端点传到另一个端点，而UDP不提供任何这样的保证。</li>
<li>HTTP(超文本传输协议)是利用TCP在两台电脑(通常是Web服务器和客户端)之间传输信息的协议。客户端使用Web浏览器发起HTTP请求给Web服务器，Web服务器发送被请求的信息给客户端。</li>
<li>记住，需要IP协议来连接网络;TCP是一种允许我们安全传输数据的机制，，使用TCP协议来传输数据的HTTP是Web服务器和客户端使用的特殊协议。</li>
<li>Socket 接口是TCP/IP网络的API，Socket接口定义了许多函数或例程，用以开发TCP/IP网络上的应用程序。</li>
</ul>
<h2 id="TCP协议的三次握手和四次挥手"><a href="#TCP协议的三次握手和四次挥手" class="headerlink" title="TCP协议的三次握手和四次挥手"></a>TCP协议的三次握手和四次挥手</h2><blockquote>
<p>尽管TCP和UDP都使用相同的网络层（IP），TCP却向应用层提供与UDP完全不同的服务。TCP提供一种面向连接的、可靠的字节流服务。面向连接意味着两个使用TCP的应用（通常是一个客户和一个服务器）在彼此交换数据之前必须先建立一个TCP连接。这一过程与打电话很相似，先拨号振铃，等待对方摘机说“喂”，然后才说明是谁。</p>
</blockquote>
<p><img src="http://ocalhyke7.bkt.clouddn.com/141612jaaglsb8ghh22sbs.png" alt=""></p>
<blockquote>
<p>字段解释</p>
</blockquote>
<pre><code>（1）序号：Seq序号，占32位，用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。
（2）确认序号：Ack序号，占32位，只有ACK标志位为1时，确认序号字段才有效，Ack=Seq+1。
（3）标志位：共6个，即URG、ACK、PSH、RST、SYN、FIN等，具体含义如下：
   （A）URG：紧急指针（urgent pointer）有效。
   （B）ACK：确认序号有效。
   （C）PSH：接收方应该尽快将这个报文交给应用层。
   （D）RST：重置连接。
   （E）SYN：发起一个新连接。
   （F）FIN：释放一个连接。
</code></pre><h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><ol>
<li>第一次握手：<br> Client将标志位SYN置为1，随机产生一个值seq=J，并将该数据包发送给Server，Client进入SYN_SENT状态，等待Server确认。</li>
<li>第二次握手：<br> Server收到数据包后由标志位SYN=1知道Client请求建立连接，Server将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发送给Client以确认连接请求，Server进入SYN_RCVD状态。</li>
<li>第三次握手：<br> Client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给Server，Server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手，随后Client与Server之间可以开始传输数据了。</li>
</ol>
<h3 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h3><pre><code>所谓四次挥手（Four-Way Wavehand）即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4
个包以确认连接的断开。在socket编程中，这一过程由客户端或服务端任一方执行close来触发
</code></pre><blockquote>
<p>由于TCP连接时全双工的，因此，每个方向都必须要单独进行关闭，这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接，收到一个FIN只是意味着这一方向上没有数据流动了，即不会再收到数据了，但是在这个TCP连接上仍然能够发送数据，直到这一方向也发送了FIN。首先进行关闭的一方将执行主动关闭，而另一方则执行被动关闭</p>
</blockquote>
<ol>
<li>第一次挥手：<br> Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。</li>
<li>第二次挥手：<br> Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。</li>
<li>第三次挥手：<br> Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。</li>
<li>第四次挥手：<br> Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手。</li>
</ol>
<h1 id="搭建IM项目需要的技术支持"><a href="#搭建IM项目需要的技术支持" class="headerlink" title="搭建IM项目需要的技术支持"></a>搭建IM项目需要的技术支持</h1><blockquote>
<p>上面的内容大概已经让你对整个网络架构有了一定的了解，接下来我们就要具体分析一下自己搭建一个IM即时通讯类项目需要用到哪些知识，该如何去做….<br>这部分作者：项望烽，毕业于浙江大学，目前是网易云信 iOS 端研发负责人。</p>
</blockquote>
<h2 id="技术问题"><a href="#技术问题" class="headerlink" title="技术问题"></a>技术问题</h2><h3 id="该选择什么样的网络通讯技术？"><a href="#该选择什么样的网络通讯技术？" class="headerlink" title="该选择什么样的网络通讯技术？"></a>该选择什么样的网络通讯技术？</h3><blockquote>
<p>IM主流网络通讯技术有两种:</p>
<pre><code>1. 基于TCP的长连接；
2. 基于HTTP短连接PULL的方式。
</code></pre></blockquote>
<pre><code>后者常见于WEB IM系统(当然现在很多WEB IM都是基于WebSocket实现)，它的优点是实现简单，方便开发上手，问题
是流量大，服务器负载较大，消息及时性无法很好地保证，对大规模的用户量支持不够，比较适合小型的IM系统,如小
网站的客户系统。
基于TCP长连接则能够更好地支持大批量用户，问题是客户端和服务器的实现比较复杂。当然也还有一些变种，如下行
使用MQTT进行服务器通知/消息的下发，上行使用HTTP短连接进行指令和消息的上传。这种方式能够保证下行消息/指
令的及时性，但是在弱网络下上行慢的问题还是比较严重。早期的来往就是基于这种方式。
</code></pre><h3 id="协议如何制定？"><a href="#协议如何制定？" class="headerlink" title="协议如何制定？"></a>协议如何制定？</h3><blockquote>
<p>IM协议选择原则一般是：易于拓展，方便覆盖各种业务逻辑，同时又比较节约流量。后一点的需求在移动端IM上尤其重要。常见的协议有：XMPP、SIP、MQTT、私有协议。</p>
</blockquote>
<ol>
<li>XMPP<br> 优点：协议开源，可拓展性强，在各个端(包括服务器)有各种语言的实现，开发者接入方便；<br> 缺点：缺点也是不少，XML表现力弱、有太多冗余信息、流量大，实际使用时有大量天坑。</li>
<li>SIP<br> SIP协议多用于VOIP相关的模块，是一种文本协议，由于我并没有实际用过，所以不做评论，但从它是文本协议这一点几乎可以断定它的流量不会小。</li>
<li>MQTT<br> 优点：协议简单，流量少；<br> 缺点：它并不是一个专门为IM设计的协议，多使用于推送。</li>
<li>私有协议<br> 市面上几乎所有主流IM APP都是是使用私有协议，一个被良好设计的私有协议优点非常明显。<br> 优点：高效，节约流量(一般使用二进制协议)，安全性高，难以破解；<br> 缺点：在开发初期没有现有样列可以参考，对于设计者的要求比较高。</li>
<li>结论<br> 一个好的协议需要满足如下条件:高效，简洁，可读性好，节约流量，易于拓展，同时又能够匹配当前团队的技术堆栈。基于如上原则，我们可以得出: 如果团队小，团队技术在IM上积累不够可以考虑使用XMPP或者MQTT+HTTP短连接的实现。反之可以考虑自己设计和实现私有协议。</li>
</ol>
<h3 id="该如何设计私有通信协议？"><a href="#该如何设计私有通信协议？" class="headerlink" title="该如何设计私有通信协议？"></a>该如何设计私有通信协议？</h3><ol>
<li>序列化与反序列化:<br> 移动互联网相对于有线网络最大特点是:带宽低，延迟高，丢包率高和稳定性差，流量费用高。所以在私有协议的序列<br> 化上一般使用二进制协议，而不是文本协议。<br> 常见的二进制序列化库有protobuf和MessagePack，当然你也可以自己实现自己的二进制协议序列化和反序列的过<br> 程，比如蘑菇街的TeamTalk。但是前面二者无论是可拓展性还是可读性都完爆TeamTalk(TeamTalk连Variant都不支<br> 持，一个int传输时固定占用4个字节)，所以大部分情况下还是不推荐自己去实现二进制协议的序列化和反序列化过<br> 程。</li>
<li>协议格式设计:<br> 基于TCP的应用层协议一般都分为包头和包体(如HTTP)，IM协议也不例外。包头一般用于表示每个请求/反馈的公共部分，如包长，请求类型，返回码等。 而包头则填充不同请求/反馈对应的信息。</li>
</ol>
<p>一个最简单的包头可以定义为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">struct PackHeader</div><div class="line">&#123;</div><div class="line">    int32_t     length_;    <span class="comment">//包长度</span></div><div class="line">    int32_t     serial_;    <span class="comment">//包序列号</span></div><div class="line">    int32_t     command_;   <span class="comment">//包请求类型</span></div><div class="line">    int32_t     code_;      <span class="comment">//返回码</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>以心跳包为例，假设当前的serial为1，心跳包的command为10，那么使用MessagePack做序列化时:length=4，serial=1，command=10，code=0，每个字段各占一个字节，包体为空，仅需要4个字节。</p>
<p>当然这是最简单的一个例子，面对真正的业务逻辑时，包体里面会需要塞入更多地信息，这个需要开发根据自己的业务逻辑总结公共部分,如为了兼容加入的协议版本号,为了负载均衡加入的模块id等。</p>
<h3 id="其他不可忽视的问题"><a href="#其他不可忽视的问题" class="headerlink" title="其他不可忽视的问题"></a>其他不可忽视的问题</h3><p>上面的内容就是一个IM系统大致的选型过程：服务方式，网络通讯协议，数据通信协议选择、协议设计。但是实际开发过程中还有大量的问题需要处理。</p>
<ol>
<li><p>协议加密:</p>
<p> 为了保证协议不容易被破解，市面上几乎所有主流IM都会对协议进行加密传输。常见的流程和HTTPS加密相似:建立连接后，客户端和服务器进行进行协商，最终客户端获得一个当前Sessino的秘钥，后续的数据传输都通过这个秘钥进行加解密。一般出于效率的考虑都会采用流式加密，如RC4。而前期协商过程则推荐使用RSA等非对称加密以增加破解难度。</p>
</li>
<li><p>快速连接（即掉线重连机制）:</p>
</li>
</ol>
<p>对iOS APP而言，因为没有真后台的存在，APP每次启动基本都需要一次重连登录(短时间内切换除外)，所以如何快速重连、重登就非常重要。</p>
<p>常见优化思路如下:</p>
<pre><code>* 本地缓存服务器IP并定期刷新。移动网络调优可以参考《iOS端移动网络调优的8条建议》；
* 合并部分请求。如加密和登录操作可以合并为同一个操作，这样就可以减少一次不必要的网络请求来回的时间；
* 简化登录后的同步请求，部分同步请求可以推迟到UI操作时进行，如群成员信息刷新。 
</code></pre><ol>
<li>连接保持（即心跳机制）</li>
</ol>
<p>一般APP实现连接保持的方式无非是采用应用层的心跳，通过心跳包的超时和其他条件(网络切换)来执行重连操作。那么问题来了:为什么要使用应用层心跳和如何设计应用层心跳。众所周知TCP协议是有KEEPALIVE这个设置选项，设置为KEEPALIVE后，客户端每隔N秒(默认是7200s)会向服务器发送一个发送心跳包。</p>
<pre><code>&gt; 但实际操作中我们更多的是使用应用层心跳。原因如下:

* KEEPALIVE对服务器负载压力比较大(服务器大大是这么说的...)；
* socks代理对KEEPALIVE并不支持；
* 部分复杂情况下KEEPALIVE会失效，如路由器挂掉，网线(移动端没有网线...)直接被拔除。

&gt; 移动端在实际操作时为了节约流量和电量一般会在心跳包上做一些小优化：

* 精简心跳包，保证一个心跳包大小在10字节之内；
* 心跳包只在空闲时发送；
* 根据APP前后台状态调整心跳包间隔 (主要是安卓)。
</code></pre><ol>
<li>消息可达（即QoS机制）:</li>
</ol>
<p>在移动网络下，丢包，网络重连等情况非常之多，为了保证消息的可达，一般需要做消息回执和重发机制。参考易信，每条消息会最多会有3次重发，超时时间为15秒，同时在发送之前会检测当前连接状态，如果当前连接并没有正确建立，缓存消息且定时检查(每隔2秒检查一次，检查15次)。所以一条消息在最差的情况下会有2分钟左右的重试时间，以保证消息的可达。</p>
<p>因为重发的存在，接受端偶尔会收到重复消息，这种情况下就需要接收端进行去重。通用的做法是每条消息都戴上自己唯一的message id(一般是uuid)。</p>
<ol>
<li>文件上传优化</li>
</ol>
<p>IM消息(包括SNS模块)内包含大量的文件上传的需求，如何优化文件的上传就成了一个比较大的主题。</p>
<blockquote>
<p>常见有下面这些优化思路:</p>
</blockquote>
<pre><code>1. 将上传流程提前:音频提供边录边传。朋友圈的图片进行预上传，选择图片后用户一般会进行文本输入，在这段时间
内后台就可以默默将选好的图片进行上传；
2. 提供闪电上传的方式:服务器根据MD5进行文件去重；
3. 优化和上传服务器的连接(参考快速连接)，提供连接重用的功能；
4. 文件分块上传:因为移动网络丢包严重，将文件分块上传可以使得一个分组包含合理数量的TCP包，使得重试概率
降，重试代价变小，更容易上传到服务器；
5. 在分包的前提下支持上传的pipeline，避免不必要的网络等待时间；
6. 支持断点续传。
</code></pre><h2 id="技术分析"><a href="#技术分析" class="headerlink" title="技术分析"></a>技术分析</h2><blockquote>
<p>这一部分我们将从腾讯QQ和58到家的实时消息系统进行分析</p>
</blockquote>
<h3 id="QQ"><a href="#QQ" class="headerlink" title="QQ"></a>QQ</h3><p>QQ既有UDP也有TCP！（作者：马剑飞）</p>
<p>不管UDP还是TCP，最终登陆成功之后，QQ都会有一个TCP连接来保持在线状态。这个TCP连接的远程端口一般是80，采用UDP方式登陆的时候，端口是8000。</p>
<p>UDP协议是无连接方式的协议，它的效率高，速度快，占资源少，但是其传输机制为不可靠传送，必须依靠辅助的算法来完成传输控制。QQ采用的通信协议以UDP为主，辅以TCP协议。由于QQ的服务器设计容量是海量级的应用，一台服务器要同时容纳十几万的并发连接，因此服务器端只有采用UDP协议与客户端进行通讯才能保证这种超大规模的服务。</p>
<p>QQ客户端之间的消息传送也采用了UDP模式，因为国内的网络环境非常复杂，而且很多用户采用的方式是通过代理服务器共享一条线路上网的方式，在这些复杂的情况下，客户端之间能彼此建立起来TCP连接的概率较小，严重影响传送信息的效率。而UDP包能够穿透大部分的代理服务器，因此QQ选择了UDP作为客户之间的主要通信协议。</p>
<p>采用UDP协议，通过服务器中转方式。因此，现在的IP侦探在你仅仅跟对方发送聊天消息的时候是无法获取到IP的。大家都知道，UDP 协议是不可靠协议，它只管发送，不管对方是否收到的，但它的传输很高效。但是，作为聊天软件，怎么可以采用这样的不可靠方式来传输消息呢？于是，腾讯采用了上层协议来保证可靠传输：如果客户端使用UDP协议发出消息后，服务器收到该包，需要使用UDP协议发回一个应答包。如此来保证消息可以无遗漏传输。之所以会发生在客户端明明看到“消息发送失败”但对方又收到了这个消息的情况，就是因为客户端发出的消息服务器已经收到并转发成功，但客户端由于网络原因没有收到服务器的应答包引起的。</p>
<p>总结来说：</p>
<pre><code>* 登陆过程，客户端client 采用TCP协议向服务器server发送信息，HTTP协议下载信息。登陆之后，会有一个TCP连
接来保持在线状态。
* 和好友发消息，客户端client采用UDP协议，但是需要通过服务器转发。腾讯为了确保传输消息的可靠，采用上层协
议来保证可靠传输。如果消息发送失败，客户端会提示消息发送失败，并可重新发送。
* 如果是在内网里面的两个客户端传文件，QQ采用的是P2P技术，不需要服务器中转。
</code></pre><h3 id="58到家实时消息系统"><a href="#58到家实时消息系统" class="headerlink" title="58到家实时消息系统"></a>58到家实时消息系统</h3><blockquote>
<p>本文内容整理自58到家平台部负责人任桃术的演讲内容。主要内容包括三部分：消息平台产生的背景、它的整体架构和系统重点以及遇到并解决了哪些问题。</p>
</blockquote>
<h4 id="消息推送平台产生的背景"><a href="#消息推送平台产生的背景" class="headerlink" title="消息推送平台产生的背景"></a>消息推送平台产生的背景</h4><p>消息平台产生的背景是基于58核心的业务——58速运，58速运的业务是做最便捷的同城的货运。</p>
<p>之前一个速运系统出现问题时，GPS上报跟滴滴的业务比较相近，区别在于滴滴是运人，我们这边是运货。这时存在着一些问题，由于GPS上报比较频繁，系统压力比较大。此外，我们向多个司机推送订单的时候，对于系统的关注性能比较弱，前期采用HTTP的方式进行消息推送，可能导致可用性和消息的到达有问题。因此我们开发了实时消息推送平台，目的就是解决系统的稳定性等性能问题，为业务部门减少压力。</p>
<h4 id="新消息推送系统的整体架构"><a href="#新消息推送系统的整体架构" class="headerlink" title="新消息推送系统的整体架构"></a>新消息推送系统的整体架构</h4><p>所有系统设计的话，都是基于某个业务场景的，这里简单介绍一下速运的业务场景。主要包括两端，一个是APP端，可能是用户使用或者是客户的司机，对于司机端知道司机处于哪个位置，会有GPS上报。另外用户下单，对应也是APP操作的。另一个是司机端，我们将用户的订单从APP-server这边推送给附近一批司机的时候，会有司机抢单的流程，把订单消息推送到各个司机端。当然还有其他实时的消息，因为作为一个通用的消息平台，不仅仅服务速运这个业务，还有58到家的家政、丽人等其他业务。</p>
<p>APP端，用户或司机会有下单的流程，有两类消息：第一类消息从APP端发起，用户下单，最终将消息推送给APP-server，另外一个就是从APP-server往APP端走。</p>
<p>msg-gate负责整合百万连接，维护与APP端的海量tcp连接；建立安全的消息通道，消息加解密、消息解压缩、消息流量监控、黑白名单；消息投递，接收APP端投递过来的消息，推送app-server投递过来的消息给APP端。因为要得到实时，优化了没有采用现有业务的方式上报。这边对于gate就是百万链接的流量整合。另外一个它会有逻辑层，将逻辑层转换MQ，这是整体的流程。</p>
<p>一般像我们服务的话，因为哪一个司机和哪个客户对接都要通过消息平台进行发送，所以对于gate层是比较特殊的，是有状态的。另外有一个逻辑层，主要职责也比较简单，就是跟业务相关的，逻辑层最核心的东西就是必须把gate层这边的消息重组到APP上，就是gate和APP有怎样的关系，这是server往APP端的东西。逻辑层职责比较简单，一个就是业务处理，还有也是业务相关的逻辑。</p>
<h4 id="新消息推送系统的设计重点"><a href="#新消息推送系统的设计重点" class="headerlink" title="新消息推送系统的设计重点"></a>新消息推送系统的设计重点</h4><blockquote>
<p>其实从整体来说，架构还是比较简单的，但最终实现并不是我们想象的那么简单，主要有两个方面的问题：协议设计和快速重连，里面可能会有很多细节。</p>
</blockquote>
<ol>
<li><p>协议设计</p>
<p> 我们在进行协议设计时候，主要考虑扩展性、可调试性和异步处理。</p>
<p> 首要是扩展性。我们可以想象一下，消息平台里面，可能会有哪些扩展的需求？第一类有各种报文，比如登录、APP业务、appserver推送、keepalive等。最终消息推送的话肯定是业务的消息，对于业务包数据的变更我们要做到可扩展。其实也很简单，对于报文的话，比如登陆的话是一个，发消息的是另外一个。另外我们消息传送的话，有几类消息，可能我是个请求消息，另外可能是发出请求之后别人会返回我一个消息，还有一个就是由APP推过来的，在网络上面只有读和写或者收发，但是并不确认这个消息到底属于哪一个类型，所以这边有一个标识。</p>
<p> 一般的话可能还有更复杂的业务，比如有好友、匿名登陆，基于这一类设计的话，可能还会有一个协议的命令，比如登陆有登陆的协议，或者好友有好友的，对应好友可能有一些子命令，比如查看好友信息。如果类似复杂的业务可以把这些消息包规范好，另外像匿名登陆可以用协议族方式，一个大的协议族可以有子命令。另外业务数据包的话，可以通过变长的包体，只要跟业务方约定好，我们是基于怎样训练化的机制就可以了，至于里边放怎样的数据，其实随便，所以就可以做到很好的扩展。</p>
<p> 另外可调试性，因为消息的流转会有很多环节，APP端开始到gate，再到MQ等等，假设某个请求包处理失败，我们如何快速知道这个消息包已经流转到哪个步骤了？是APP端的问题，还是msg-gate的问题，还是msg-logic的问题，还是redis的问题？解决的方案比较简单，就给一个统一标识就可以了。</p>
<p> 还有一个异步化的支持。这种消息通道最重要的是解决通道问题，所有消息处理不能是同步的，必须是异步的，你发一个消息出去，ABC三个包，你收到XYZ三个包之后，你怎么知道它是对应的，就是对应关系的话我们怎么处理，就是加一个ID</p>
<p> 你可以维持一个发送包的上下文队列，当你收到包之后你从对应找到上下文做到处理。异步化处理的话两点，第一点是要有队列，另外一个就是必须要有一个回调，基本是队列加回调，因为收到小型包之后回去怎么做不确定，一般是这两个可以解决。</p>
</li>
<li><p>快速重连</p>
<p> 另外一个TCP的快速重连，连接之后只是说明我们可以收发包消息了，但是连接之前要做一些验证，比如是不是合法用户等。</p>
<p> 我们解决快速重连的方法就是射线保持，不会清掉就没必要重复创建了。由于无线网络特别不稳定，射线保持也会引入其他的问题。如果断开，射线还在这里的话有两类消息，一类消息从APP-server推送到APP端的时候，因为TCP已经断开了，对应的其实你是发不出去消息的，这种情况下怎么办。</p>
<p> 可能会导致往一群司机推送订单的时候，这些司机就断开了，推送会失败，现在的做法会把射线清掉。因为这个情况没法重建TCP链接，因为是从server端到APP端的。</p>
<p> 另外一类，APP端往app-server推送消息的时候，因为我们这边TCP连接之后肯定有一些机制保持连接，一种通过心跳，另外再发消息的时候，我会重新建立TCP连接，会出现一个问题，重建连接的时候，我发送连接请求的服务器的话，可能不是上一台，之前连了一台服务器，现在网络点开重连，选的是另外一台服务器，这个是有问题的，导致用户在两台上边登陆了，这个问题怎么解决。</p>
<p> 第一个问题，我们其实不好再重建TCP连接，因为是APP－server到APP的推送，好的做法就是把这个射线清掉，因为我们维护了APP端到gate的连接，这个是需要做的。另外一个就是像这种APP端同时登陆两个gate的时候，首先第一步把上一个清掉，重新再建立新的TCP连接。这个东西会有问题就是说网络不稳定，出现APP端跟好几个接入层进行了连接，优化的方案就是会在APP端做一些处理，比如可以记录上一次我和哪一台服务器连接，下一次网络有连接的时候就走上一台的，这样就不会导致登陆两个服务器的情况。</p>
</li>
</ol>
<p>现在的IM传输层基本都是使用TCP，有了epoll等技术后，多连接就不是瓶颈了，单机几十万链接没什么问题。58同城现在线上单机连接好像是10w？（可能单机性能测试可以到百万，线上一般跑到几十万）</p>
<p>个人不清楚QQ使用UPD作为传输层协议的初衷，但猜测是因为10多年前Client 10K问题没有得到很好解决，一台服务器支撑不了1W个TCP连接 ，腾讯的同时在线量高，没办法，只有用UDP了，但UDP又不可靠，故只能在UDP上实现TCP的超时／重传／确认等机制啦。</p>
<p>以上是我对到家实时消息推送平台的介绍，希望能够对大家有所帮助。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/安卓开发/" rel="tag">#安卓开发</a>
          
            <a href="/tags/即时通讯/" rel="tag">#即时通讯</a>
          
            <a href="/tags/个人主观/" rel="tag">#个人主观</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/29/webview调用js出错/" rel="next" title="安卓webview调用js出错">
                <i class="fa fa-chevron-left"></i> 安卓webview调用js出错
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/02/个人安卓学习进阶知识点/" rel="prev" title="个人安卓学习进阶知识点">
                个人安卓学习进阶知识点 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/08/30/即时通讯类项目开发总结/"
           data-title="即时通讯类项目开发总结" data-url="http://yoursite.com/2016/08/30/即时通讯类项目开发总结/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ocalhyke7.bkt.clouddn.com/IMG_2037%2820161116-094615%29.jpg"
               alt="Patrick_Zhao" />
          <p class="site-author-name" itemprop="name">Patrick_Zhao</p>
          <p class="site-description motion-element" itemprop="description">不卑不亢,不骄不躁,不气不馁</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#网络结构"><span class="nav-number">1.</span> <span class="nav-text">网络结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OSI七层模型"><span class="nav-number">1.1.</span> <span class="nav-text">OSI七层模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP-IP-5层模型及对应的协议"><span class="nav-number">1.2.</span> <span class="nav-text">TCP/IP 5层模型及对应的协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP-UDP-Http-Socket的区别"><span class="nav-number">1.3.</span> <span class="nav-text">TCP,UDP,Http,Socket的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP协议的三次握手和四次挥手"><span class="nav-number">1.4.</span> <span class="nav-text">TCP协议的三次握手和四次挥手</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#三次握手"><span class="nav-number">1.4.1.</span> <span class="nav-text">三次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四次挥手"><span class="nav-number">1.4.2.</span> <span class="nav-text">四次挥手</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#搭建IM项目需要的技术支持"><span class="nav-number">2.</span> <span class="nav-text">搭建IM项目需要的技术支持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#技术问题"><span class="nav-number">2.1.</span> <span class="nav-text">技术问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#该选择什么样的网络通讯技术？"><span class="nav-number">2.1.1.</span> <span class="nav-text">该选择什么样的网络通讯技术？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#协议如何制定？"><span class="nav-number">2.1.2.</span> <span class="nav-text">协议如何制定？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#该如何设计私有通信协议？"><span class="nav-number">2.1.3.</span> <span class="nav-text">该如何设计私有通信协议？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他不可忽视的问题"><span class="nav-number">2.1.4.</span> <span class="nav-text">其他不可忽视的问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#技术分析"><span class="nav-number">2.2.</span> <span class="nav-text">技术分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QQ"><span class="nav-number">2.2.1.</span> <span class="nav-text">QQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#58到家实时消息系统"><span class="nav-number">2.2.2.</span> <span class="nav-text">58到家实时消息系统</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#消息推送平台产生的背景"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">消息推送平台产生的背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新消息推送系统的整体架构"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">新消息推送系统的整体架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新消息推送系统的设计重点"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">新消息推送系统的设计重点</span></a></li></ol></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Patrick_Zhao</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"noteszhaoshuai123"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
